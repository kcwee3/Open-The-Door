<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartoon Door Puzzle</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');

        body {
            font-family: 'Fredoka One', cursive;
            margin: 0;
            padding: 0;
            background-color: #FFD54F;
            color: #4E342E;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .game-container {
            background-color: #FFF9C4;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
            display: flex;
            max-width: 1000px;
            width: 95%;
        }
        .left-panel {
            flex: 2;
            padding-right: 20px;
        }
        .right-panel {
            flex: 1;
            border-left: 3px dashed #4E342E;
            padding-left: 20px;
        }
        #doorCanvas {
            width: 100%;
            height: 300px;
            border: 5px solid #4E342E;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .code-input {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .code-input input {
            width: 50px;
            height: 50px;
            font-size: 24px;
            text-align: center;
            border: 3px solid #4E342E;
            border-radius: 10px;
            background-color: #FFECB3;
        }
        button {
            background-color: #FF9800;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 18px;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #F57C00;
        }
        #message {
            font-size: 18px;
            margin: 10px 0;
            text-align: center;
        }
        #timer {
            font-size: 24px;
            text-align: center;
            margin: 10px 0;
        }
        .token-display {
            font-size: 24px;
            text-align: center;
            margin: 20px 0;
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            border-radius: 10px;
        }
        h2 {
            color: #FF5722;
            text-align: center;
        }
        .previous-keys {
            height: 200px;
            overflow-y: auto;
            background-color: #FFECB3;
            border-radius: 10px;
            padding: 10px;
        }
        .previous-keys p {
            margin: 5px 0;
            font-size: 16px;
        }
        .cartoon-effect {
            transition: transform 0.3s;
        }
        .cartoon-effect:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="left-panel">
            <h1 style="text-align: center;">Cartoon Door Puzzle</h1>
            <div id="doorCanvas"></div>
            <div class="code-input">
                <input type="text" maxlength="1" class="cartoon-effect">
                <input type="text" maxlength="1" class="cartoon-effect">
                <input type="text" maxlength="1" class="cartoon-effect">
                <input type="text" maxlength="1" class="cartoon-effect">
                <input type="text" maxlength="1" class="cartoon-effect">
            </div>
            <button id="submitGuess" class="cartoon-effect">Try to Open!</button>
            <p id="message"></p>
            <div id="timer"></div>
            <div class="token-display cartoon-effect">
                Your Tokens: <span id="tokenCount">0</span>
            </div>
        </div>
        <div class="right-panel">
            <h2>Previous Keys</h2>
            <div class="previous-keys" id="previousKeys"></div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let lastAttemptTime = 0;
        const cooldownTime = 600000; // 10 minutes in milliseconds
        let scene, camera, renderer, door;
        let tokens = 0;
        let previousKeys = [];

        // Initialize 3D door
        function init3DDoor() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ alpha: true });
            renderer.setSize(300, 300);
            document.getElementById('doorCanvas').appendChild(renderer.domElement);

            // Create a cartoon-style door
            const doorGeometry = new THREE.BoxGeometry(2, 3, 0.2);
            const doorTexture = new THREE.TextureLoader().load('https://example.com/door-texture.jpg');
            const doorMaterial = new THREE.MeshPhongMaterial({ map: doorTexture });
            door = new THREE.Mesh(doorGeometry, doorMaterial);
            scene.add(door);

            // Add doorknob
            const knobGeometry = new THREE.SphereGeometry(0.15, 32, 32);
            const knobMaterial = new THREE.MeshPhongMaterial({ color: 0xFFD700 });
            const knob = new THREE.Mesh(knobGeometry, knobMaterial);
            knob.position.set(0.8, 0, 0.1);
            door.add(knob);

            // Add lighting
            const light = new THREE.PointLight(0xFFFFFF, 1, 100);
            light.position.set(0, 0, 5);
            scene.add(light);

            camera.position.z = 5;

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            door.rotation.y = Math.sin(Date.now() * 0.001) * 0.1;
            renderer.render(scene, camera);
        }

        init3DDoor();

        document.getElementById('submitGuess').addEventListener('click', submitGuess);

        function submitGuess() {
            const inputs = document.querySelectorAll('.code-input input');
            const guess = Array.from(inputs).map(input => input.value).join('');
            const currentTime = Date.now();

            if (currentTime - lastAttemptTime < cooldownTime) {
                showMessage('Please wait for the timer to complete before your next attempt.', 'red');
                return;
            }

            if (guess.length !== 5 || isNaN(guess)) {
                showMessage('Please enter a valid 5-digit number.', 'red');
                return;
            }

            lastAttemptTime = currentTime;
            updateTimer();

            // Send the guess to the server (mock response for demonstration)
            setTimeout(() => {
                const isCorrect = Math.random() < 0.1; // 10% chance of being correct
                if (isCorrect) {
                    showMessage('Congratulations! You've opened the door and won 1000 tokens!', 'green');
                    door.rotation.y = Math.PI / 2; // Open the door
                    addTokens(1000);
                    // Reset the game
                    lastAttemptTime = 0;
                    inputs.forEach(input => input.value = '');
                } else {
                    showMessage('Wrong code. Try again when the timer completes.', 'red');
                }
                addPreviousKey(guess);
            }, 1000);
        }

        function showMessage(text, color) {
            const messageElement = document.getElementById('message');
            messageElement.textContent = text;
            messageElement.style.color = color;
        }

        function updateTimer() {
            const timerElement = document.getElementById('timer');
            const updateTimerText = () => {
                const currentTime = Date.now();
                const timeDiff = currentTime - lastAttemptTime;
                if (timeDiff < cooldownTime) {
                    const remainingTime = Math.ceil((cooldownTime - timeDiff) / 1000);
                    const minutes = Math.floor(remainingTime / 60);
                    const seconds = remainingTime % 60;
                    timerElement.textContent = `Next attempt in: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                    setTimeout(updateTimerText, 1000);
                } else {
                    timerElement.textContent = 'You can make another attempt now!';
                }
            };
            updateTimerText();
        }

        function addTokens(amount) {
            tokens += amount;
            document.getElementById('tokenCount').textContent = tokens;
        }

        function addPreviousKey(key) {
            previousKeys.unshift(key);
            if (previousKeys.length > 10) previousKeys.pop();
            updatePreviousKeysDisplay();
        }

        function updatePreviousKeysDisplay() {
            const keysContainer = document.getElementById('previousKeys');
            keysContainer.innerHTML = '';
            previousKeys.forEach(key => {
                const p = document.createElement('p');
                p.textContent = key;
                keysContainer.appendChild(p);
            });
        }

        // Auto-focus next input
        document.querySelectorAll('.code-input input').forEach((input, index) => {
            input.addEventListener('input', function() {
                if (this.value.length === this.maxLength) {
                    const nextInput = document.querySelectorAll('.code-input input')[index + 1];
                    if (nextInput) nextInput.focus();
                }
            });
        });

        tg.expand();
        tg.MainButton.setText('Close Game').show().onClick(() => tg.close());
    </script>
</body>
</html>